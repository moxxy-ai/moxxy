<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>moxxy Command & Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
        }

        .font-mono {
            font-family: 'Fira Code', monospace;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scroll-hidden::-webkit-scrollbar {
            display: none;
        }

        .scroll-styled::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-styled::-webkit-scrollbar-track {
            background: transparent;
        }

        .scroll-styled::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.2);
            border-radius: 4px;
        }

        .tab-btn.active {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.5);
            color: #6ee7b7;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
        }

        .tab-btn {
            background: rgba(30, 41, 59, 0.5);
            border-color: #334155;
            color: #94a3b8;
        }

        .pane-hidden {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="h-screen w-screen overflow-hidden flex flex-col">

    <!-- Navbar -->
    <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 z-10">
        <div class="flex items-center gap-3">
            <h1
                class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 tracking-tight">
                moxxy Swarm C&C
            </h1>
        </div>
        <div class="flex items-center gap-4 text-sm font-medium">
            <button onclick="openModal('create-agent-modal')"
                class="bg-emerald-500 hover:bg-emerald-400 text-slate-900 px-4 py-1.5 rounded-md transition-colors shadow-[0_0_10px_rgba(16,185,129,0.3)]">
                + Provision Node
            </button>
        </div>
    </header>

    <!-- Main Layout Grid -->
    <div class="flex-grow flex overflow-hidden">

        <!-- Sidebar: Active Agents -->
        <aside class="w-64 border-r border-slate-800 bg-slate-900/50 flex flex-col">
            <div class="p-4 border-b border-slate-800">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Active Nodes</h3>
            </div>
            <div id="agent-list" class="flex-grow overflow-y-auto p-2 space-y-1 scroll-styled">
                <div class="text-slate-500 italic text-sm p-3">Loading nodes...</div>
            </div>
        </aside>

        <!-- Center Workspace -->
        <main class="flex-grow flex flex-col bg-[#0b1120] relative">

            <!-- Agent Header -->
            <div
                class="h-14 border-b border-slate-800 px-6 flex items-center justify-between bg-slate-900/80 backdrop-blur-md">
                <div class="flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.8)]"></span>
                    <h2 id="active-agent-name" class="font-semibold text-slate-200">Select an Agent</h2>
                </div>
                <div class="flex gap-2" id="agent-tabs">
                    <button onclick="switchTab('chat')" class="px-3 py-1 text-sm rounded-md tab-btn active"
                        data-tab="chat">Chat</button>
                    <button onclick="switchTab('memory')" class="px-3 py-1 text-sm rounded-md tab-btn"
                        data-tab="memory">Memory</button>
                    <button onclick="switchTab('skills')" class="px-3 py-1 text-sm rounded-md tab-btn"
                        data-tab="skills">Skills</button>
                    <button onclick="switchTab('vault')" class="px-3 py-1 text-sm rounded-md tab-btn"
                        data-tab="vault">Vault</button>
                </div>
            </div>

            <!-- Agent Panes -->
            <div class="flex-grow overflow-hidden relative p-6">

                <!-- PANE: Chat -->
                <div id="pane-chat" class="h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-emerald-400">Direct Agent Interface</h3>
                    </div>
                    <div id="chat-messages"
                        class="flex-grow overflow-y-auto scroll-styled space-y-4 mb-4 p-4 bg-slate-900/50 rounded-lg border border-slate-800">
                        <div class="text-slate-500 italic text-sm text-center mt-4">Initiate sequence to begin.</div>
                    </div>
                    <form onsubmit="cmdSendChat(event)" class="mt-auto flex gap-2">
                        <input type="text" id="chat-input" required autocomplete="off"
                            class="flex-grow bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-sm focus:border-emerald-500 focus:outline-none placeholder-slate-500 shadow-inner"
                            placeholder="Send a prompt to the Swarm...">
                        <button type="submit"
                            class="bg-emerald-500 hover:bg-emerald-400 text-slate-900 px-6 py-2 rounded-lg font-bold transition shadow-[0_0_15px_rgba(16,185,129,0.2)] tracking-wide">EXECUTE</button>
                    </form>
                </div>

                <!-- PANE: Memory -->
                <div id="pane-memory" class="h-full flex flex-col pane-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-emerald-300">Short-Term Context</h3>
                        <button onclick="fetchSTM()"
                            class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1 rounded">Refresh</button>
                    </div>
                    <div id="stm-content"
                        class="bg-slate-900 border border-slate-800 rounded-lg p-4 font-mono text-sm overflow-y-auto flex-grow text-slate-300 scroll-styled whitespace-pre-wrap">
                        Awaiting context...
                    </div>
                </div>

                <!-- PANE: Skills -->
                <div id="pane-skills" class="h-full flex flex-col pane-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-purple-400">Skill Builder</h3>
                        <button onclick="openModal('create-skill-modal')"
                            class="text-xs bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 text-purple-300 px-3 py-1 rounded shadow-[0_0_10px_rgba(168,85,247,0.2)]">+
                            Synthesize Skill</button>
                    </div>
                    <div id="skills-list" class="grid grid-cols-2 gap-4 overflow-y-auto scroll-styled content-start">
                        <!-- Skill Cards -->
                    </div>
                </div>

                <!-- PANE: Vault -->
                <div id="pane-vault" class="h-full flex flex-col pane-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-amber-300">Secrets Vault</h3>
                        <button onclick="openModal('add-vault-modal')"
                            class="text-xs bg-amber-500/20 hover:bg-amber-500/30 border border-amber-500/50 text-amber-300 px-3 py-1 rounded">+
                            Inject Secret</button>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden flex-grow">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-800/50 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3">Key Name</th>
                                    <th class="px-6 py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody id="vault-list" class="divide-y divide-slate-800">
                                <!-- Vault rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>

        <!-- Right Panel: Global Context & Terminals -->
        <aside class="w-[450px] border-l border-slate-800 flex flex-col bg-[#0b1120]">

            <!-- Global Swarm Intelligence -->
            <div class="h-1/3 border-b border-slate-800 flex flex-col">
                <div class="px-4 py-3 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                        Swarm Databank
                    </h3>
                </div>
                <ul id="swarm-content" class="flex-grow overflow-y-auto p-4 space-y-3 scroll-styled bg-slate-900/20">
                    <li class="text-slate-500 text-xs italic">Syncing global memory...</li>
                </ul>
            </div>

            <!-- Live SSE Terminal -->
            <div class="h-2/3 flex flex-col bg-black">
                <div class="px-4 py-2 border-b border-slate-800 flex justify-between items-center bg-slate-900/80">
                    <h3 class="text-xs font-bold text-slate-400 uppercase font-mono tracking-widest">Live Telemetry</h3>
                    <div class="flex items-center gap-2">
                        <span id="sse-indicator" class="w-2 h-2 rounded-full bg-red-500"></span>
                        <span class="text-[10px] text-slate-500 font-mono">SSE Stream</span>
                    </div>
                </div>
                <div id="terminal-out"
                    class="p-3 font-mono text-[11px] leading-relaxed text-slate-300 overflow-y-auto flex-grow scroll-styled whitespace-pre-wrap break-all">
                </div>
            </div>

        </aside>

    </div>

    <!-- Modals -->

    <!-- Create Agent Modal -->
    <div id="create-agent-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-slate-900 border border-slate-700 w-[500px] rounded-xl shadow-2xl p-6 relative">
            <button onclick="closeModal('create-agent-modal')"
                class="absolute top-4 right-4 text-slate-400 hover:text-white">✕</button>
            <h2 class="text-xl font-bold mb-4">Provision New Node</h2>
            <form onsubmit="cmdCreateAgent(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Agent Name (lowercase, no
                        spaces)</label>
                    <input type="text" id="ca-name" required
                        class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none placeholder-slate-600"
                        placeholder="e.g. researcher">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Telegram Bot Token (Optional)</label>
                    <input type="password" id="ca-token"
                        class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none"
                        placeholder="1234:ABCDEF...">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Persona (System Prompt)</label>
                    <textarea id="ca-persona" required rows="4"
                        class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none placeholder-slate-600 font-mono"
                        placeholder="You are an expert..."></textarea>
                </div>
                <button type="submit"
                    class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-medium py-2 rounded-md transition mt-2">Initialize
                    Instance & Boot</button>
            </form>
        </div>
    </div>

    <!-- Create Skill Modal -->
    <div id="create-skill-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div
            class="bg-slate-900 border border-slate-700 w-[800px] rounded-xl shadow-2xl p-6 relative flex flex-col max-h-[90vh]">
            <button onclick="closeModal('create-skill-modal')"
                class="absolute top-4 right-4 text-slate-400 hover:text-white">✕</button>
            <h2 class="text-xl font-bold mb-4 text-purple-400">Synthesize Skill Payload</h2>

            <form onsubmit="cmdInstallSkill(event)" class="space-y-4 overflow-y-auto scroll-styled pr-2 flex-grow">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Skill Name</label>
                        <input type="text" id="cs-name" required
                            class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm focus:border-purple-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Version (SemVer)</label>
                        <input type="text" id="cs-version" value="1.0.0" required
                            class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm focus:border-purple-500 focus:outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Skill Description (Agent
                        Prompt)</label>
                    <textarea id="cs-desc" required rows="2"
                        class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm focus:border-purple-500 focus:outline-none"></textarea>
                </div>

                <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                    <label class="block text-xs font-medium text-slate-300 mb-2 uppercase tracking-wide">Sandbox
                        Permissions</label>
                    <div class="flex gap-4 text-sm">
                        <label class="flex items-center gap-2"><input type="checkbox" id="cs-net"
                                class="accent-purple-500"> Network</label>
                        <label class="flex items-center gap-2"><input type="checkbox" id="cs-env"
                                class="accent-purple-500"> Environment</label>
                        <label class="flex items-center gap-2"><input type="checkbox" id="cs-fsr"
                                class="accent-purple-500"> FS Read</label>
                        <label class="flex items-center gap-2"><input type="checkbox" id="cs-fsw"
                                class="accent-purple-500"> FS Write</label>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1 flex justify-between">
                        <span>run.sh (Alpine Linux Sandbox Context)</span>
                        <span class="text-slate-500">#!/bin/sh implicit</span>
                    </label>
                    <textarea id="cs-bash" required rows="10"
                        class="w-full bg-[#0a0f18] border border-slate-700 rounded px-3 py-2 text-sm focus:border-purple-500 focus:outline-none font-mono text-emerald-300"
                        spellcheck="false"></textarea>
                </div>

                <button type="submit"
                    class="w-full bg-purple-500 hover:bg-purple-400 text-slate-900 font-medium py-2 rounded-md transition mt-2">Inject
                    Extensible Capability</button>
            </form>
        </div>
    </div>

    <!-- Add Vault Secret Modal -->
    <div id="add-vault-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-slate-900 border border-slate-700 w-[400px] rounded-xl shadow-2xl p-6 relative">
            <button onclick="closeModal('add-vault-modal')"
                class="absolute top-4 right-4 text-slate-400 hover:text-white">✕</button>
            <h2 class="text-xl font-bold mb-4 text-amber-500">Inject Vault Secret</h2>
            <form onsubmit="cmdSetVault(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Configuration Key</label>
                    <select id="cv-key" required
                        class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm focus:border-amber-500 focus:outline-none font-mono text-slate-200">
                        <option value="" disabled selected>Select a channel or secret type...</option>
                        <option value="telegram_token">telegram_token (Telegram Bot)</option>
                        <option value="discord_token">discord_token (Discord Bot)</option>
                        <option value="slack_bot_token">slack_bot_token (Slack Bot)</option>
                        <option value="whatsapp_enabled">whatsapp_enabled (Twilio Webhook: 'true')</option>
                        <option value="custom_env_var">custom_env_var (Manual Environment Var)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Secure Value</label>
                    <input type="password" id="cv-val" required
                        class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm focus:border-amber-500 focus:outline-none font-mono placeholder-slate-600"
                        placeholder="e.g. xoxb-1234...">
                </div>
                <button type="submit"
                    class="w-full bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium py-2 rounded-md transition mt-2">Encrypt
                    & Save</button>
            </form>
        </div>
    </div>

    <script>
        let agentDb = [];
        let activeAgent = null;

        // Modals
        const openModal = (id) => document.getElementById(id).classList.remove('hidden');
        const closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');

            ['chat', 'memory', 'skills', 'vault'].forEach(t => {
                document.getElementById(`pane-${t}`).classList.add('pane-hidden');
            });
            document.getElementById(`pane-${tabName}`).classList.remove('pane-hidden');

            if (tabName === 'skills') fetchSkills();
            if (tabName === 'vault') fetchVault();
        }

        // Data Fetching
        async function fetchAgents() {
            try {
                const res = await fetch('/api/agents');
                const data = await res.json();
                agentDb = data.agents || [];
                renderAgentList();

                if (agentDb.length > 0 && !activeAgent) {
                    selectAgent(agentDb.includes('default') ? 'default' : agentDb[0]);
                }
            } catch (err) { console.error("Agent fetch failed", err); }
        }

        function renderAgentList() {
            const container = document.getElementById('agent-list');
            container.innerHTML = '';
            if (agentDb.length === 0) {
                container.innerHTML = '<div class="text-slate-500 italic text-sm p-3">No nodes provisioned.</div>';
                return;
            }

            agentDb.forEach(agent => {
                const div = document.createElement('div');
                const isAct = agent === activeAgent;
                div.className = `flex items-center gap-3 p-3 rounded-md cursor-pointer transition border ${isAct ? 'bg-slate-800/80 border-slate-600' : 'hover:bg-slate-800/40 border-transparent text-slate-400'}`;
                div.onclick = () => selectAgent(agent);
                div.innerHTML = `
                    <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center font-bold text-slate-300 border border-slate-700 shadow-inner">
                        ${agent.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-grow">
                        <div class="text-sm font-semibold ${isAct ? 'text-emerald-400' : 'text-slate-200'}">${agent}</div>
                        <div class="text-[10px] text-slate-500 uppercase tracking-wide">Online</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectAgent(agent) {
            activeAgent = agent;
            document.getElementById('active-agent-name').textContent = agent;
            renderAgentList();
            fetchSTM();
            const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
            if (activeTab === 'skills') fetchSkills();
            if (activeTab === 'vault') fetchVault();
        }

        async function fetchSTM() {
            if (!activeAgent) return;
            try {
                const res = await fetch(`/api/agents/${activeAgent}/memory/short`);
                const data = await res.json();
                document.getElementById('stm-content').textContent = data.content || 'Memory void.';
            } catch (err) { document.getElementById('stm-content').textContent = 'Link failed: ' + err; }
        }

        async function fetchSkills() {
            if (!activeAgent) return;
            try {
                const res = await fetch(`/api/agents/${activeAgent}/skills`);
                const data = await res.json();
                const container = document.getElementById('skills-list');
                container.innerHTML = '';
                if (!data.success || !data.skills || data.skills.length === 0) {
                    container.innerHTML = '<div class="col-span-2 text-slate-500 italic text-sm">No skills mounted.</div>';
                    return;
                }
                data.skills.forEach(sk => {
                    container.innerHTML += `
                        <div class="bg-slate-800/40 border border-slate-700 p-4 rounded-lg hover:border-purple-500/50 transition">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-slate-200">${sk.name}</h4>
                                <span class="bg-slate-700/50 text-slate-400 text-[10px] px-2 py-0.5 rounded border border-slate-600 font-mono">${sk.version}</span>
                            </div>
                            <p class="text-xs text-slate-400 mb-3 line-clamp-2">${sk.description}</p>
                            <div class="flex gap-2">
                                ${sk.needs_network ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400 border border-blue-500/20">NET</span>' : ''}
                                ${sk.needs_env ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400 border border-amber-500/20">ENV</span>' : ''}
                                ${sk.needs_fs_write ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-red-500/20 text-red-400 border border-red-500/20">FSW</span>' : ''}
                            </div>
                        </div>
                    `;
                });
            } catch (err) { console.error("Skills fetch failed", err); }
        }

        async function fetchVault() {
            if (!activeAgent) return;
            try {
                const res = await fetch(`/api/agents/${activeAgent}/vault`);
                const data = await res.json();
                const container = document.getElementById('vault-list');
                container.innerHTML = '';
                if (!data.success || !data.keys || data.keys.length === 0) {
                    container.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-slate-500 italic text-sm">Vault empty.</td></tr>';
                    return;
                }
                data.keys.forEach(k => {
                    container.innerHTML += `
                        <tr class="hover:bg-slate-800/30">
                            <td class="px-6 py-3 font-mono text-slate-300">${k}</td>
                            <td class="px-6 py-3"><span class="bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-2 py-1 rounded text-xs font-medium tracking-wide">SECURED &bull;&bull;&bull;&bull;</span></td>
                        </tr>
                    `;
                });
            } catch (err) { console.error("Vault fetch failed", err); }
        }

        async function fetchSwarm() {
            try {
                const res = await fetch('/api/memory/swarm');
                const data = await res.json();
                const list = document.getElementById('swarm-content');
                list.innerHTML = '';
                if (!data.records || data.records.length === 0) {
                    list.innerHTML = '<li class="text-slate-500 text-xs italic">Databank void.</li>';
                    return;
                }
                data.records.forEach(rec => {
                    list.innerHTML += `<li class="p-3 bg-slate-800/50 rounded border border-slate-700/50 text-[11px] text-slate-400 leading-relaxed font-mono whitespace-pre-wrap">${rec}</li>`;
                });
            } catch (err) { }
        }

        // Actions
        async function cmdCreateAgent(e) {
            e.preventDefault();
            const payload = {
                name: document.getElementById('ca-name').value,
                description: document.getElementById('ca-persona').value,
                telegram_token: document.getElementById('ca-token').value || null
            };
            const btn = e.target.querySelector('button');
            btn.textContent = 'Provisioning...';
            try {
                const res = await fetch('/api/agents', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const r = await res.json();
                if (r.success) {
                    closeModal('create-agent-modal');
                    e.target.reset();
                    await fetchAgents();
                    selectAgent(payload.name);
                } else alert("Error: " + r.error);
            } catch (err) { alert(err) }
            btn.textContent = 'Initialize Instance & Boot';
        }

        async function cmdSetVault(e) {
            e.preventDefault();
            if (!activeAgent) return;

            let rawKey = document.getElementById('cv-key').value;
            if (rawKey === 'custom_env_var') {
                rawKey = prompt("Enter custom configuration key name:");
                if (!rawKey) return; // User cancelled
            }

            const payload = {
                key: rawKey,
                value: document.getElementById('cv-val').value
            };
            try {
                const res = await fetch(`/api/agents/${activeAgent}/vault`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const r = await res.json();
                if (r.success) {
                    closeModal('add-vault-modal');
                    e.target.reset();
                    fetchVault();
                } else alert("Error: " + r.error);
            } catch (err) { alert(err) }
        }

        async function cmdInstallSkill(e) {
            e.preventDefault();
            if (!activeAgent) return;

            const name = document.getElementById('cs-name').value;
            const version = document.getElementById('cs-version').value;
            const desc = document.getElementById('cs-desc').value;
            const bash = document.getElementById('cs-bash').value;

            const toml = `name = "${name}"\ndescription = "${desc}"\nversion = "${version}"\nentrypoint = "run.sh"\nrun_command = "sh"\nneeds_network = ${document.getElementById('cs-net').checked}\nneeds_fs_write = ${document.getElementById('cs-fsw').checked}\nneeds_fs_read = ${document.getElementById('cs-fsr').checked}\nneeds_env = ${document.getElementById('cs-env').checked}`;
            const md = `# \`${name}\` Tool\n\n## Description\n${desc}\n\n## Usage\n<invoke name="${name}">args</invoke>`;

            const payload = { new_manifest_content: toml, new_run_sh: bash, new_skill_md: md };
            const btn = e.target.querySelector('button');
            btn.textContent = 'Injecting...';

            try {
                const res = await fetch(`/api/agents/${activeAgent}/install_skill`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const r = await res.json();
                if (r.success) {
                    closeModal('create-skill-modal');
                    e.target.reset();
                    fetchSkills();
                } else alert("Error: " + r.error);
            } catch (err) { alert(err) }
            btn.textContent = 'Inject Extensible Capability';
        }

        async function cmdSendChat(e) {
            e.preventDefault();
            if (!activeAgent) return;
            const input = document.getElementById('chat-input');
            const prompt = input.value;
            input.value = '';

            const msgBox = document.getElementById('chat-messages');
            if (msgBox.innerHTML.includes('Initiate sequence')) msgBox.innerHTML = '';

            // Render User Bubble
            msgBox.innerHTML += `
                <div class="flex justify-end fade-in">
                    <div class="bg-emerald-500/20 border border-emerald-500/30 text-emerald-100 rounded-2xl rounded-tr-md px-5 py-3 text-sm max-w-[80%] inline-block shadow-sm">
                        ${prompt}
                    </div>
                </div>
            `;
            msgBox.scrollTop = msgBox.scrollHeight;

            // Render Thinking Indicator
            const thinkingId = 'thinking-' + Date.now();
            msgBox.innerHTML += `
                <div id="${thinkingId}" class="flex justify-start fade-in">
                    <div class="bg-indigo-500/10 border border-indigo-500/30 text-indigo-300 rounded-2xl rounded-tl-md px-5 py-3 text-sm inline-block italic flex gap-2 items-center">
                        <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-pulse"></span>
                        <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-pulse" style="animation-delay: 150ms"></span>
                        <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-pulse" style="animation-delay: 300ms"></span>
                    </div>
                </div>
            `;
            msgBox.scrollTop = msgBox.scrollHeight;

            try {
                const res = await fetch(`/api/agents/${activeAgent}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const r = await res.json();

                document.getElementById(thinkingId).remove();

                // Render Agent Bubble
                msgBox.innerHTML += `
                    <div class="flex justify-start fade-in mt-2 mb-2">
                        <div class="bg-slate-800/80 backdrop-blur-sm border border-slate-700 text-slate-200 rounded-2xl rounded-tl-md px-5 py-4 text-sm max-w-[85%] inline-block whitespace-pre-wrap leading-relaxed shadow-md">
                            ${r.success ? r.response : '<span class="text-red-400">Error: ' + r.error + '</span>'}
                        </div>
                    </div>
                `;
            } catch (err) {
                document.getElementById(thinkingId).remove();
                msgBox.innerHTML += `
                    <div class="flex justify-start fade-in mt-2 mb-2">
                        <div class="bg-red-900/40 border border-red-500/50 text-red-200 rounded-2xl rounded-tl-md px-5 py-3 text-sm max-w-[80%] inline-block shadow-md">
                            System Failure: ${err}
                        </div>
                    </div>
                `;
            }
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        // Live Log SSE Telemetry
        function setupLogStream() {
            const terminal = document.getElementById('terminal-out');
            const indicator = document.getElementById('sse-indicator');

            const evtSource = new EventSource('/api/logs');
            evtSource.onopen = () => { indicator.className = 'w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_5px_#10b981]'; };
            evtSource.onerror = () => { indicator.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse'; };

            evtSource.onmessage = (e) => {
                // Ignore empty or weird lines to keep it clean, but tail standard logs
                if (e.data.trim() === '') return;

                // Colorize common INFO/WARN/ERROR tags for slickness
                let line = e.data
                    .replace(/INFO/g, '<span class="text-blue-400">INFO</span>')
                    .replace(/WARN/g, '<span class="text-amber-400">WARN</span>')
                    .replace(/ERROR/g, '<span class="text-red-400">ERROR</span>');

                const span = document.createElement('div');
                span.innerHTML = line;
                span.className = 'border-l border-slate-700/50 pl-2 mb-1';
                terminal.appendChild(span);

                // Keep max 200 lines to prevent DOM bloat
                if (terminal.children.length > 200) terminal.removeChild(terminal.firstChild);
                terminal.scrollTop = terminal.scrollHeight;
            };
        }

        // Boot Init
        setupLogStream();
        fetchAgents().then(() => fetchSwarm());
        setInterval(() => {
            fetchSTM();
            fetchSwarm();
        }, 3000);

    </script>
</body>

</html>